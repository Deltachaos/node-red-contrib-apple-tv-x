<script type="text/html" data-template-name="atvx-config">
  <div class="form-row">
    <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-config-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <label for="node-config-input-backend"><i class="fa fa-pencil"></i> Backend</label>
    <select id="node-config-input-backend" style="width: 70%;">
      <option value="native">native (no support tvOS 15)</option>
      <option value="pyatv">pyatv (python library)</option>
    </select>
  </div>

  <div class="form-row">
    <label for="node-config-input-atv"><i class="fa fa-tv"></i> Apple TV</label>
    <div style="display: inline-block; position: relative; width: 70%;">
      <input type="text" id="node-config-input-atv" placeholder="Apple TV">
      <a id="node-config-input-scan" class="red-ui-button" style="margin-left: 10px;"><i class="fa fa-search"></i></a>
    </div>
  </div>

  <div class="form-row" id="native-pairing">
    <label>
      <i class="fa fa-retweet"></i>
      Pairing
    </label>
    <a id="node-config-input-conn" class="editor-button" title="Select an Apple TV above">
      Initiate Connection
    </a>
    <label style="margin-left: 10px; width: 30px !important;">
      Pin:
    </label>
    <input type="number" id="node-config-input-pincode" style="width: 85px; margin-left: 10px;">
    <a id="node-config-input-pair" style="vertical-align: middle; margin-left: 10px;" class="editor-button">
      <i class="fa fa-check-square"></i>
    </a>
  </div>

  <div class="form-row">
    <label for="node-config-input-token"><i class="fa fa-key"></i> <span id="pyatv-airplay">Token</span></label>
    <input type="text" id="node-config-input-token" placeholder="Token">
  </div>

  <div class="form-row" id="pyatv-companion">
    <label for="node-config-input-companion"><i class="fa fa-key"></i> Companion</label>
    <input type="text" id="node-config-input-companion" placeholder="Token">
  </div>
</script>

<script type="text/html" data-help-name="atvx-config">
  <p>Connection to Apple TV</p>
  <h3>Configuration</h3>
  <dl class="message-properties">
    <dt class="optional">Name<span class="property-type">string</span></dt>
    <dd>Choose any name to identify your node</dd>
    <dt class="required">Token<span class="property-type">string</span></dt>
    <dd>Apple TV pairing Token</dd>
  </dl>
</script>

<script type="text/javascript">
  RED.nodes.registerType('atvx-config', {
    category: 'config',
    defaults: {
      name: { value: '' },
      backend: { value: 'native' },
      companion: { value: '' },
    },
    credentials: {
      atv: { type: 'text', required: true },
      token: { type: 'text', required: true },
    },
    label: function () {
      return (this.name || 'Apple TV');
    },
    oneditprepare: function () {
      let node = this;

      setTimeout(function () {
        let $device = $('#node-config-input-atv').val();
        $('#node-config-input-atv').replaceWith('<select id="node-config-input-atv" style="width: 85%;"></select>');
        if ($device) {
          $('#node-config-input-atv').append('<option value="'+$device+'">'+$device.split(';')[0]+'</option>');
        }

        _backend();
      }, 150);

      $('#node-config-input-backend').change(function() {
        _backend();
      });

      $('#node-config-input-scan').click(function() {
        let $backend = $('#node-config-input-backend').val();
        let $device  = $('#node-config-input-atv').val();

        if ($backend) {
          $.getJSON('atvx/discover', {
            backend: $backend,
          }).done(function (devices) {
            if (devices.length === 0) {
              RED.notify('No devices retrieved, check your Apple TVs connection settings', 'error');
              return;
            }

            if (typeof (devices.error) !== 'undefined') {
              RED.notify(devices.error, 'error');
              return;
            }

            $('#node-config-input-atv').children().remove();
            devices.forEach(function (device) {
              if (!$device || $device.split(';')[1] != device.uid) {
                $('#node-config-input-atv').append('<option value="' + device.name + ';' + device.uid + '" data-name="' + device.name + '" data-id="' + device.uid + '">' + device.name + '</option>');
              }
            });

            if ($device) { $('#node-config-input-atv').append('<option value="'+$device+'">'+$device.split(';')[0]+'</option>').val($device); }
          });
        }
      });

      $('#node-config-input-pair').click(function() {
        let $pincode = $('#node-config-input-pincode').val();
        if ($pincode) {
          $.getJSON('atvx/pincode', {
            pincode: $pincode
          });
        }
      });

      $('#node-config-input-conn').click(function() {
        let $device  = $('#node-config-input-atv').val();
        if ($device) {
          $.getJSON('atvx/pair', {
            device: $device,
          }).done(function (data) {
            if (!data.error) {
              if (data.token) $('#node-config-input-token').val(data.token);
            } else {
              RED.notify(data.error, 'error');
            }
          });
        }
      });

      function _backend() {
        let $backend = $('#node-config-input-backend').val();
        if ($backend == 'native') {
          $('#native-pairing').show();
          $('#pyatv-airplay').text('Token');
          $('#pyatv-companion').hide();
        } else {
          $('#native-pairing').hide();
          $('#pyatv-airplay').text('AirPlay');
          $('#pyatv-companion').show();
        }
      }
    }
  });
</script>